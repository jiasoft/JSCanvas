<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Test</title>
<meta name="Keywords" content="canvas demo" />
<meta name="Description" content="canvas demo" />
<meta name="robots" content="index, follow" />
<meta name="googlebot" content="index, follow" />
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
<style>
body{background:#000;text-align:center;padding:0px;margin:0px;}
#gmagepan{background:#fff;box-shadow:0px 0px 5px #000;}

</style>

</head>
<body>

	<canvas width="320" height="480" id="gmagepan"></canvas>
	<script type="text/javascript" src="../jfcanvas.js"></script>
	<script>
		function initGame(){
			JF.stage.init("gmagepan");
			var dwidth = 74;
			var dheight = 55;
			var margin = 5;
			var table = [];
			var coll = [];
			var pos;
			var ob;
			function TBObj(id,x,y,w,h,r){
				JF.DObject.call(this,id,x,y,w,h,r);
				this.Text = "";
				var _this = this;
				this.addFrame(function(c2d){
					c2d.fillStyle = '#8c1010';
					c2d.font = 'bold 40px 宋体';
					c2d.fillText(_this.Text,15,40);
				});
			}
			TBObj.prototype = JF.DObject.prototype;
			
			
			function ExchangeEmpty(tar){
				
				var tarxy;
				for(var i = 0;i < table.length;i++){
					for(var j = 0;j < table[i].length;j++){
						if(table[i][j].tar.id == tar.id)
							tarxy = [i,j];
					}
				}
				if(!tarxy) return;
				var empty_xy
				for(var i = 0;i < table.length;i++){
					for(var j = 0;j < table[i].length;j++){
						if(table[i][j].tar.id == 'empty')
							empty_xy = [i,j];
					}
				}
				
				tar.animates({
					x:table[empty_xy[0]][empty_xy[1]].tar.x,
					y:table[empty_xy[0]][empty_xy[1]].tar.y
				},100);
				table[empty_xy[0]][empty_xy[1]].tar.animates({
					x:tar.x,
					y:tar.y
				},100,function(){
					if(checkSucc()){
						JF.stage.add(endBox);
						endBox.animates({x:0,y:0,width:320,height:480,alpha:1},150)
					}
				});
				
				table[tarxy[0]][tarxy[1]].tar = table[empty_xy[0]][empty_xy[1]].tar;
				table[empty_xy[0]][empty_xy[1]].tar = tar;
			}
			function checkSucc(){
				var preobj =null;
				for(i = 0;i < table.length;i++){
					
					for(j = 0;j < table[i].length;j++){
						
						if(preobj && table[i][j].tar.Text < preobj.tar.Text)
							return false;
						
						preobj = table[i][j];
						if(i == rows-2 && j == cols-1)
							return true;
					}
				}
				return true;
			}
			function findIndex(tar){
				if(!tar)
					return;
				var i=0,j=0;
				for(i = 0;i < table.length;i++){
					
					for(j = 0;j < table[i].length;j++){
						
						if(table[i][j].tar.id == tar.id){
							return [i,j];
						}
					}
				}
				return null;
			}
			var rows = 6;
			var cols = 4;
			var numar = [];

			for(var l = 1;l <= rows*cols-1;l++)
				numar[l-1] = l;
			for(var i = 0;i < rows;i++){
				coll = [];
				for(var j = 0;j < cols;j++){
					pos = {x:margin*(j+1)+dwidth*j,y:margin*(i+1)+dheight*i};
					
			
					if(i == rows-1 && j == cols-1 ){
						ob = new JF.DObject('empty',pos.x,pos.y,dwidth,dheight);
						ob.Text = 9999;
					}else{
						ob = new TBObj('ob_id_'+i+"_"+j,pos.x,pos.y,dwidth,dheight);
						ob.setBGBorder(2,'#c9a014','#f9f3e0');
						var m = numar.splice(Math.ceil((numar.length-1)*Math.random()),1);
						ob.Text = m[0];
					}
					
					pos.tar = ob;
					coll.push(pos);
					JF.stage.add(ob);
				}
				table.push(coll);
			}
			
			
			
			var moveObj;

			var startPos;
			JF.stage.addEvent(function(eObj){
				switch(eObj.type){
					case 'touch.start':
						if(eObj.curObj && eObj.curObj.id == "startbox"){
							eObj.curObj.animates({
								rotate:Math.PI,scaleX:0.1,scaleY:0.1,x:320,y:340
							},500,function(){
								JF.stage.remove(eObj.curObj);
							});
							return;
						}
						moveObj = eObj.curObj;
						startPos = {x:eObj.touchPosList[0].x,y:eObj.touchPosList[0].y}
					break;
					case 'touch.move':
						
					break;
					case 'touch.end':
					
						var x = eObj.touchPosList[0].x;
						var y = eObj.touchPosList[0].y;
						var xys = findIndex(moveObj);
						if(!xys)
							return;
			
					
						if(Math.abs(x-startPos.x) > Math.abs(y - startPos.y)){
							if(x-startPos.x > 0)
								xys[1]++;
							else if(x-startPos.x < 0)
								xys[1] --
						}else if(Math.abs(x-startPos.x) < Math.abs(y - startPos.y)){
							if(y - startPos.y > 0)
								xys[0] ++;
							else if(y - startPos.y < 0)
								xys[0] --;
						};
						if(xys[0] > rows -1)
							return;
						if(xys[0][1] > cols -1)
							return;
						if(table[xys[0]] && table[xys[0]][xys[1]] && table[xys[0]][xys[1]].tar.id == 'empty'){
							

							ExchangeEmpty(moveObj);
						}
						moveObj = null;

					break;
				}
			});
			
			
			var startBox = new JF.DObject('startbox');
			startBox.width = 320;
			startBox.height = 480;
			startBox.setBGBorder(1,'#fff','#fff');
			startBox.alpha=0.8;
			startBox.addFrame(function(c2d){
				c2d.fillStyle = '#000';
				c2d.font = '400 12px 宋体';
				c2d.fillText('移动格子，使数字顺序排列',80,50);
				c2d.fillStyle = 'red';
				c2d.fillText('★只支持智能手机，请用手机浏览器打开',50,90);
				c2d.fillStyle = '#000';
				c2d.font = 'bold 30px 宋体';
				c2d.fillText('点击屏幕开始',70,200);
			});
			JF.stage.add(startBox);
			JF.stage.play();
			
			var endBox = new JF.DObject('endbox',160,240,0,0);
			endBox.setBGBorder(1,"#ffffff","#ffffff");
			endBox.alpha = 0;
			endBox.addFrame(function(c2d){
				c2d.fillStyle = '#000';
				c2d.font = 'bold 30px 宋体';
				c2d.fillText('恭喜您通过',70,200);
			});
			
			
		}
		var t = new JF.DObject();
		t.Text = "";
		t.x = 0;
		t.addFrame(function(c2d){
			c2d.fillStyle = '#000';
			c2d.font = 'bold 12px 宋体';
			c2d.fillText(t.Text,5,12);
		});
		JF.stage.add(t);
		setTimeout(function(){
			initGame();
		},200);
	</script>
	
</body>
</html> 